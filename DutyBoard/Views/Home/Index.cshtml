@model HomeVM
@{
    ViewData["Title"] = "Доска дежурств";
    string day;
}
<div class="mainPage">
    <div class="mainTable">
        <div class="cardHeader">
            <h2>Список дежурств</h2>
        </div>
        <div class="scroll-table">
            <table>
                <thead>
                    <tr>
                        <td>День недели</td>
                        <td>Период</td>
                        <td>Дежурный</td>
                    </tr>
                </thead>
            </table>
            <div class="scroll-table-body">
                <table>
                    <tbody>
                        @foreach (var item in Model.MainTable)
                        {
                            @if (item.Roster.DaysOfWeekId == 6 || item.Roster.DaysOfWeekId == 7)
                            {
                                day = "holiday";
                            }
                            else
                            {
                                day = "workday";
                            }
                            <tr class="@day">
                                <td>@item.Roster.DaysOfWeek.DayOfWeekName</td>
                                <td>@item.DateStart.ToString("dd.MM.yyyy HH:mm") - @item.DateEnd.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>
                                    <select asp-for="@item.EmployeeId" asp-items="@Model.Employees" class="form-select-sm @day" onchange="selectChanged(this)" id="@item.MappingId.ToString()">
                                    </select>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="cards">
        <div class="card">
            <div class="cardHeader">
                <h2>Статистика всего</h2>
            </div>
            <canvas id="polarArea"></canvas>
        </div>
        <div class="card">
            <div class="cardHeader">
                <h2>Статистика по дням</h2>
            </div>
            <canvas id="bar"></canvas>
        </div>
        
    </div>
    <div class="cards">
        <div class="card">
            <div class="cardHeader">
                <h2>Дежурства</h2>
            </div>
            <table>
                @foreach (var item in Model.Workdays.OrderBy(x => x.Workday.IsAlways).ThenBy(x => x.Workday.DateWork).ThenBy(x => x.Workday.Roster.RosterId))
                {
                    if (item.Workday.IsAlways)
                    {
                        day = item.Roster.DaysOfWeek.DayOfWeekName;
                    }
                    else
                    {
                        day = item.Workday.DateWork.ToLongDateString();
                    }
                    <tr>
                        <td>

                            @item.Employee.FullName<br>
                            <span>@day, @item.Roster.StartTime.ToString(@"hh\:mm") - @item.Roster.EndTime.ToString(@"hh\:mm")</span>

                        </td>
                    </tr>
                }
            </table>
        </div>
        <div class="card">
            <div class="cardHeader">
                <h2>Отпуска</h2>
            </div>
            <ul class="list-group">
                @foreach (var item in Model.Holidays.OrderBy(x => x.Holiday.DateStart).ThenBy(x => x.Holiday.DateFinish).ThenBy(x => x.Employee.FullName))
                {
                    <li>
                        <div class="row">

                            <div class="col-11">
                                <a href="#" class="col text-start" id=@item.Holiday.HolidayId.ToString() title="Изменить" data-bs-toggle="modal" data-bs-target="#modal" onClick="Edit(this)" style="text-decoration: none;">

                                    <h5 class="mb-0">@item.Employee.FullName</h5>
                                    <p class="mb-0">@item.Holiday.DateStart.ToString(@"dd.MM.yyyy") - @item.Holiday.DateFinish.ToString(@"dd.MM.yyyy")</p>
                                </a>
                            </div>
                            <div class="col-1  text-end ">
                                <a href="#" class="del" title="Удалить" id=@item.Holiday.HolidayId.ToString() data-bs-toggle="modal" data-bs-target="#modal" onClick="Delete(this)">
                                    <h4 class="py-2">
                                        <i class="fa-regular fa-trash-can del"></i>
                                    </h4>
                                </a>
                            </div>
                        </div>
                    </li>
                }
            </ul>
        </div>
    </div>


</div>
<!-- Modal -->
<div class="modal fade" id="modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div id="edit-content"></div>
        </div>
    </div>
</div>
@section Scripts{
    <script src="~/js/statistic.js"></script>
    <script>

        $(document).ready(function () {
            getStatistic();
        });
        let chart;
        let bar;
        function selectChanged(value) {
            let url = '@Url.Action("EditMapping")?mapp=' + value.id + '&emp=' + value.value;
            $.ajax({
                type: 'GET',
                url: url,

                success: function (data) {
                    data = JSON.parse(data)

                    for (let i = 0; i < data.AllCounts.length; i++) {
                        chart.data.datasets[0].data[i] = data.AllCounts[i];
                        chart.update();
                        bar.data.datasets[0].data[i] = data.WorkdayCounts[i];
                        bar.data.datasets[1].data[i] = data.HolidayCounts[i];
                        bar.update();
                    }
                }
            });
            toastr["success"]('Дежурство изменено');
        };

        function getStatistic() {
            var stat = @Html.Raw(Model.Statistics);
            chart = fillPolarArea(stat.Employees, stat.AllCounts);
            bar = fillBar(stat.Employees, stat.WorkdayCounts, stat.HolidayCounts);
        }
    </script>
    )
}