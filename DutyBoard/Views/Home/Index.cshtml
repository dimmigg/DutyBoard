@model HomeVM
@{
    ViewData["Title"] = "Доска дежурств";
    string day;
}
<div class="mainPage">
    <div class="mainTable">
        <div class="cardHeader">
            <h2>Список дежурств</h2>
        </div>
        <div class="scroll-table">
            <table>
                <thead>
                    <tr>
                        <td>День недели</td>
                        <td>Период</td>
                        <td>Дежурный</td>
                    </tr>
                </thead>
            </table>
            <div class="scroll-table-body">
                <table>
                    <tbody>
                        @foreach (var item in Model.MainTable)
                        {
                            @if (item.Roster.DaysOfWeekId == 6 || item.Roster.DaysOfWeekId == 7)
                            {
                                day = "holiday";
                            }
                            else
                            {
                                day = "workday";
                            }
                            <tr class="@day">
                                <td>@item.Roster.DaysOfWeek.DayOfWeekName</td>
                                <td>@item.DateStart.ToString("dd.MM.yyyy HH:mm") - @item.DateEnd.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>
                                    <select asp-for="@item.EmployeeId" asp-items="@Model.Employees" class="form-select-sm @day" onchange="selectChanged(this)" id="@item.MappingId.ToString()">
                                    </select>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="cards">
        <div class="statistics">
            <div class="cardHeader">
                <h2>Статистика всего</h2>
            </div>
            <canvas id="polarArea"></canvas>
        </div>
        <div class="card">
            <div class="cardHeader">
                <h2>Дежурства</h2>
            </div>
        </div>
    </div>
    <div class="cards">
        <div class="statistics">
            <div class="cardHeader">
                <h2>Статистика по дням</h2>
            </div>
            <canvas id="bar"></canvas>
        </div>
        <div class="card">
            <div class="cardHeader">
                <h2>Отпуска</h2>
            </div>
        </div>
    </div>


</div>
<!-- Modal -->
<div class="modal fade" id="modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div id="edit-content"></div>
        </div>
    </div>
</div>
@section Scripts{
    <script src="~/js/statistic.js"></script>
    <script>

        $(document).ready(function () {
            getStatistic();
        });
        let chart;
        let bar;
        function selectChanged(value) {
            let url = '@Url.Action("EditMapping")?mapp=' + value.id + '&emp=' + value.value;
            $.ajax({
                type: 'GET',
                url: url,

                success: function (data) {
                    data = JSON.parse(data)
                    
                    for (let i = 0; i < data.AllCounts.length; i++) {
                        chart.data.datasets[0].data[i] = data.AllCounts[i];
                        chart.update();
                        bar.data.datasets[0].data[i] = data.WorkdayCounts[i];
                        bar.data.datasets[1].data[i] = data.HolidayCounts[i];
                        bar.update();
                    }
                }
            });
            toastr["success"]('Дежурство изменено');
        };

        function getStatistic() {
            var stat = @Html.Raw(Model.Statistics);
            chart = fillPolarArea(stat.Employees, stat.AllCounts);
            bar = fillBar(stat.Employees, stat.WorkdayCounts, stat.HolidayCounts);
        }
    </script>
    )
}